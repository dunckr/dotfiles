#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   worktree-rm BRANCH_NAME
#
# Removes a git worktree with the specified branch name.
# This deletes the folder and removes the worktree from git.
#
# Run this script from the worktree container directory (parent of all worktrees).

# Check if branch name provided
if [[ $# -eq 0 ]]; then
  echo "Usage: worktree-rm BRANCH_NAME" >&2
  echo "" >&2
  echo "Removes a git worktree with the specified branch name" >&2
  echo "Run from the worktree container directory" >&2
  exit 1
fi

BRANCH_NAME="$1"

# Check if worktree directory exists
if [[ ! -d "$BRANCH_NAME" ]]; then
  echo "Error: Worktree '$BRANCH_NAME' not found in current directory" >&2
  echo "Please run this script from the worktree container directory" >&2
  echo "(the parent directory containing all worktrees)" >&2
  exit 1
fi

# Remove the worktree using git worktree remove
echo "Removing worktree: $BRANCH_NAME"
if ! git worktree remove "$BRANCH_NAME"; then
  echo "Error: Failed to remove worktree" >&2
  echo "If the worktree has uncommitted changes, use: git worktree remove --force $BRANCH_NAME" >&2
  exit 1
fi

# Delete the branch
echo "Deleting branch: $BRANCH_NAME"
if ! git branch -D "$BRANCH_NAME" 2>/dev/null; then
  echo "Warning: Could not delete branch '$BRANCH_NAME' (it may not exist or already be deleted)" >&2
fi

echo "Worktree '$BRANCH_NAME' removed successfully"
