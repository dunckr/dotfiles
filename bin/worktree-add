#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   worktree-add BRANCH_NAME
#
# Creates a git worktree with the specified branch name, copies .idea and .env
# from main worktree, runs pnpm install, and opens in IntelliJ.
#
# Run this script from the worktree container directory (parent of all worktrees).

# Check if branch name provided
if [[ $# -eq 0 ]]; then
  echo "Usage: worktree-add BRANCH_NAME" >&2
  echo "" >&2
  echo "Creates a git worktree with the specified branch name" >&2
  echo "Run from the worktree container directory" >&2
  exit 1
fi

BRANCH_NAME="$1"

# Check if main worktree exists
if [[ ! -d "main" ]]; then
  echo "Error: 'main' directory not found in current directory" >&2
  echo "Please run this script from the worktree container directory" >&2
  echo "(the parent directory containing all worktrees)" >&2
  exit 1
fi

# Pull latest changes in main worktree
echo "Pulling latest changes in main worktree..."
cd main
if ! git pull origin main; then
  echo "Error: Failed to pull latest changes from origin/main" >&2
  cd ..
  exit 1
fi
cd ..

# Create the worktree
echo "Creating worktree for branch: $BRANCH_NAME"
if ! git worktree add "$BRANCH_NAME"; then
  echo "Error: Failed to create worktree" >&2
  exit 1
fi

WORKTREE_PATH="$(cd "$BRANCH_NAME" && pwd)"

# Generate a random port number between 3000 and 9000
PORT=$(( 3000 + RANDOM % 6001 ))
echo "Generated port number: $PORT"

# Copy .idea directory from main if it exists
if [[ -d "main/.idea" ]]; then
  echo "Copying .idea directory from main..."
  cp -r "main/.idea" "$WORKTREE_PATH/"
else
  echo "Warning: main/.idea not found, skipping copy"
fi

# Copy .env file from main if it exists
if [[ -f "main/.env" ]]; then
  echo "Copying .env file from main..."
  cp "main/.env" "$WORKTREE_PATH/"
  # Replace port 3000 with the generated port number
  if grep -q "3000" "$WORKTREE_PATH/.env"; then
    sed -i '' "s/3000/$PORT/g" "$WORKTREE_PATH/.env"
    echo "Updated port from 3000 to $PORT in .env"
  fi
  # Add or update PORT environment variable
  if grep -q "^PORT=" "$WORKTREE_PATH/.env"; then
    sed -i '' "s/^PORT=.*/PORT=$PORT/" "$WORKTREE_PATH/.env"
    echo "Updated PORT=$PORT in .env"
  else
    echo "PORT=$PORT" >> "$WORKTREE_PATH/.env"
    echo "Added PORT=$PORT to .env"
  fi
else
  echo "Warning: main/.env not found, skipping copy"
fi

# Copy CLAUDE.md from main if it exists
if [[ -f "main/CLAUDE.md" ]]; then
  echo "Copying CLAUDE.md from main..."
  cp "main/CLAUDE.md" "$WORKTREE_PATH/"
else
  echo "Warning: main/CLAUDE.md not found, skipping copy"
fi

# Copy AGENTS.md from main if it exists
if [[ -f "main/AGENTS.md" ]]; then
  echo "Copying AGENTS.md from main..."
  cp "main/AGENTS.md" "$WORKTREE_PATH/"
else
  echo "Warning: main/AGENTS.md not found, skipping copy"
fi

# Copy .claude directory from main if it exists
if [[ -d "main/.claude" ]]; then
  echo "Copying .claude directory from main..."
  cp -r "main/.claude" "$WORKTREE_PATH/"
else
  echo "Warning: main/.claude not found, skipping copy"
fi

# Run pnpm install in the new worktree
echo "Running pnpm install..."
cd "$WORKTREE_PATH"
if ! pnpm install --prefer-offline; then
  echo "Error: pnpm install failed" >&2
  exit 1
fi

# Open in IntelliJ IDEA (skip if second argument provided)
if [[ $# -lt 2 ]]; then
  echo "Opening in IntelliJ IDEA..."
  open -a "IntelliJ IDEA" "$WORKTREE_PATH"
else
  echo "Skipping IntelliJ IDEA (second argument provided)"
fi

echo "Worktree created successfully at: $WORKTREE_PATH"
echo "WORKTREE_PATH=$WORKTREE_PATH"
